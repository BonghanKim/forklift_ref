<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>An MPC tracking controller.: Interaction with the onboard controller</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">An MPC tracking controller.
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Interaction with the onboard controller </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>There are two methods to communicate with the onboard controller in order to send commands and receive sensor readings. The first one is telnet connection via Ethernet cable to Navserver, which runs on the controller. This connection can be used only to read sensor data. The second one is the CAN bus, which can be used for sending commands as well. However, the CAN bus baudrate is rather low, and there is likely to be high delay in receiving the messages from onboard controller due to high load on the bus.</p>
<p>Refer to one of these pages for more information on CAN:</p><ul>
<li><a class="el" href="pCANOverview.html">Controller area network (CAN) and CANopen overview</a><ul>
<li><a class="el" href="pCANOverview.html#pCANOverviewCAN">Controller area network (CAN)</a></li>
<li><a class="el" href="pCANOverview.html#pCANOverviewCANopen">CANopen</a></li>
</ul>
</li>
<li><a class="el" href="pCANFormat.html">Format of the CAN messages</a><ul>
<li><a class="el" href="pCANFormat.html#pCANSend">Messages to the onboard controller</a></li>
<li><a class="el" href="pCANFormat.html#pCANRecv">Messages from the onboard controller</a></li>
<li><a class="el" href="pCANFormat.html#pCANStandard">Standard CANopen messages</a></li>
</ul>
</li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="pCANCable"></a>
CAN connection</h1>
<p>We use a USB cable to connect to the CAN bus on SnowWhite. The cable is produced by Kvaser.</p><ul>
<li><a href="http://www.kvaser.com/en/developer/canlib.html">http://www.kvaser.com/en/developer/canlib.html</a></li>
<li><a href="http://www.kvaser.com/canlib-webhelp/">http://www.kvaser.com/canlib-webhelp/</a></li>
</ul>
<p>The Linux version of the driver currently supports only version 2.6 of the kernel and may have problems with SMP, 64bit and real-time priorities.</p>
<p>There is one more option to connect to CAN bus (Abdel has used it under Linux) using hardware and drivers from <a href="http://www.peak-system.com/fileadmin/media/linux/index.htm">http://www.peak-system.com/fileadmin/media/linux/index.htm</a></p>
<p><br  />
 </p>
<h1><a class="anchor" id="pIntRecv"></a>
Reading data from sensors</h1>
<p>The position of the car is updated each 60 ms.</p>
<h2><a class="anchor" id="pIntRecvTelnet"></a>
Connection to Navserver</h2>
<p>Connection to the Navserver: address = 192.168.100.100, port = 5432.</p>
<p>Navserver outputs data in a simple textual format. We can get the necessary data by subscribing for the 'env' and 'state' updates, which are sent each 60ms. 'env' and 'state' readings are printed on separate lines. Both lines are sent in one tcp packet. The interval between reception of two packets varies from 50ms to 70ms.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>There is a a significant delay in execution of requested steering angle (or in sensor reports),</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="classstateContainer.html" title="A simple container, which stores states of a car. Estimated state should be used as the initial state...">stateContainer</a>. It would be nice to know more about operation of the onboard controller.</dd></dl>
<h2><a class="anchor" id="pIntRecvCAN"></a>
CAN bus</h2>
<p>The Kvaser CAN cable controller has internal clock, which is used to assign timestamps to messages. The precision of these stamps is 100 microseconds. The clock starts after activation of the bus.</p>
<p>Sample dump from the CAN bus (old version of the SnowWhite firmware): </p><pre class="fragment">Channel   ID    Flag   DLC D0  1   2   3   4   5   6   D7      Time     Direction
---------------------------------------------------------------------------------
 0         524         2   0   0                               0.021390 R
 0         779         7   0   0   0   0   0   0   0           0.021900 R
 0         780         7   0   0   0   0   0   0   0           0.022410 R
 0         128         0                                       0.022670 R
 0         515         8   4   0 128   0   0   0   0   0       0.023180 R
 0         652         8   0   0   0   0   0   0   0   0       0.023820 R
 0         387         3  31   0   0                           0.024080 R
 0         395         7   0   1   0   0   0   0   0           0.024780 R
 0         396         7  32  60   0   0   0   0   0           0.025230 R
 0         651         8   0   0   0   0   0   0   0   0       0.025740 R
 0         907         6   0   0   0   0   0   0               0.026120 R
 0        1163         6   0   0   0   0   0   0               0.026570 R
 0        1803  R      1                                       0.041100 R
 0        1804  R      1                                       0.041360 R
 0        1803         1   5                                   0.041800 R
 0        1804         1   5                                   0.042000 R
 0         523         2 128   2                               0.081160 R
 0         524         2   0   0                               0.081420 R
 0         779         7   0   0   0   0   0   0   0           0.081930 R
 0         780         7   0   0   0   0   0   0   0           0.082440 R
 0         128         0                                       0.082700 R
 0         515         8   4   0 128   0   0   0   0   0       0.083280 R
 0         652         8   0   0   0   0   0   0   0   0       0.083790 R
 0         387         3  31   0   0                           0.084110 R
 0         395         7   0   1   0   0   0   0   0           0.084750 R
 0         396         7  32  60   0   0   0   0   0           0.085200 R
 0         651         8   0   0   0   0   0   0   0   0       0.085710 R
 0         907         6   0   0   0   0   0   0               0.086160 R
 0        1163         6   0   0   0   0   0   0               0.086540 R
 0         523         2 128   2                               0.141200 R
 0         524         2   0   0                               0.141450 R
 0         779         7   0   0   0   0   0   0   0           0.141960 R
 0         780         7   0   0   0   0   0   0   0           0.142480 R
 0         128         0                                       0.142730 R
 0         515         8   4   0 128   0   0   0   0   0       0.143310 R
 0         387         3  31   0   0                           0.143760 R
 0         395         7   0   1   0   0   0   0   0           0.144780 R
 0         396         7  32  60   0   0   0   0   0           0.145230 R
 0         651         8   0   0   0   0   0   0   0   0       0.145740 R
 0         652         8   0   0   0   0   0   0   0   0       0.146190 R
 0         907         6   0   0   0   0   0   0               0.146640 R
 0        1163         6   0   0   0   0   0   0               0.147020 R
 0         523         2 128   2                               0.201100 R
 0         524         2   0   0                               0.201420 R
 0         779         7   0   0   0   0   0   0   0           0.201930 R
 0         780         7   0   0   0   0   0   0   0           0.202440 R
 0         128         0                                       0.202700 R
 0         515         8   4   0 128   0   0   0   0   0       0.203210 R
 0         387         3  31   0   0                           0.203790 R
 0         396         7  32  60   0   0   0   0   0           0.204240 R
 0         652         8   0   0   0   0   0   0   0   0       0.204680 R
 0         395         7   0   1   0   0   0   0   0           0.205200 R
 0         651         8   0   0   0   0   0   0   0   0       0.205640 R
 0         907         6   0   0   0   0   0   0               0.206090 R
 0        1163         6   0   0   0   0   0   0               0.206540 R
 0        1803  R      1                                       0.221070 R
 0        1804  R      1                                       0.221320 R
 0        1803         1 133                                   0.221710 R
 0        1804         1 133                                   0.221960 R</pre><p><br  />
 </p>
<h1><a class="anchor" id="pIntSend"></a>
Sending commands</h1>
<p>The commands can be sent only via CAN bus. Format of the respective CAN messages is described in <a class="el" href="pCANFormat.html">Format of the CAN messages</a>.</p>
<p>The sampling time of the internal control loop is 20 ms. The execution of received commands begins on the next iteration of the internal control loop (20 ms). The flags in the last CAN message with the commands determine in how many loops the commands are reused.</p>
<p><br  />
 </p>
<h1><a class="anchor" id="pIntSync"></a>
Synchronization</h1>
<p>There are several synchronization options.</p>
<p>In the first case the MPC controller starts when the data is received from connection to navserver (see test_01_telnet.cpp).</p>
<p>In the second case MPC controller is synchronized with CAN messages (id = 128) since we cannot synchronize with messages with sensor readings. The sensor readings are obtained from the CAN messages. This approach is more difficult to implement.</p>
<p>In the third case MPC controller is also synchronized with CAN messages, however data is obtained from Navserver. This approach is more difficult to implement than the first one. The delay between the reception of the data and the start of the controller is bigger than in the first case. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
